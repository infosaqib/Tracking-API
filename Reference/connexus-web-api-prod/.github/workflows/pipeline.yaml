name: Deploy Connexus & SOW-RFQ to EC2
'on':
  push:
    branches:
      - dev
      - test
      - stage
      - prod
jobs:
  deploy-connexus:
    if: github.ref == 'refs/heads/dev'
    runs-on: blacksmith
    env:
      AWS_REGION: us-east-1
      REPO_URI: >-
        ${{ secrets.AWS_ACCOUNT_ID
        }}.dkr.ecr.us-east-1.amazonaws.com/connexus-api
      NODE_ENV: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Notify Google Chat - Starting Dev Deployment
        env:
          WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
                  "text": "üöÄ Starting deployment of Connexus API to Dev.\n\n Commit: ${{ github.event.head_commit.message }}"
                }' $WEBHOOK_URL
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: '${{ secrets.AWS_ACCESS_KEY_ID }}'
          aws-secret-access-key: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          aws-region: '${{ env.AWS_REGION }}'
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1
      - name: Build & Push Connexus API
        run: |
          IMAGE_TAG=connexusdev-${{ github.sha }}
          docker build --build-arg NODE_ENV=$NODE_ENV \
          -f apps/connexus-be/Dockerfile \
          -t $REPO_URI:$IMAGE_TAG .
          docker push $REPO_URI:$IMAGE_TAG
      - name: Install SSH Client
        run: sudo apt-get install -y sshpass
      - name: Deploy Connexus API on EC2
        run: |
          cat <<EOF > private_key.pem
          ${{ secrets.EC2_SSH_KEY_NON_PROD }}
          EOF
          chmod 600 private_key.pem
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{
          secrets.EC2_USER_NON_PROD }}@${{ secrets.EC2_HOST_NON_PROD }} << EOF
            IMAGE_TAG=connexusdev-${{ github.sha }}
            CONTAINER_NAME=connexus-api-sow-dev
            PORT=3000
            docker stop \$CONTAINER_NAME || true
            docker rm \$CONTAINER_NAME || true
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REPO_URI
            docker pull $REPO_URI:\$IMAGE_TAG
            docker run -d --name \$CONTAINER_NAME -p \$PORT:3000 \
              --env NODE_ENV=development \
              --env DATABASE_URL="${{ secrets.AWS_LOCAL_DEV_DB_SECRET }}" \
              --env SHADOW_DATABASE_URL="${{ secrets.AWS_LOCAL_DEV_SHADOW_DB_SECRET }}" \
              --env COGNITO_USER_POOL_ID="${{ secrets.DEV_COGNITO_USER_POOL_ID }}" \
              --env COGNITO_CLIENT_ID="${{ vars.DEV_COGNITO_CLIENT_ID }}" \
              --env COGNITO_CLIENT_SECRET="${{ vars.DEV_COGNITO_CLIENT_SECRET }}" \
              --env AWS_REGION="${{ secrets.DEV_COGNITO_REGION }}" \
              --env AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              --env AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              --env AUTH_JWT_SECRET="${{ secrets.DEV_AUTH_JWT_SECRET }}" \
              --env FRONTEND_URL="${{ secrets.DEV_FRONTEND_URL }}" \
              --env EMAIL_ASSET_URL="${{ vars.DEV_EMAIL_ASSET_URL }}" \
              --env ADMIN_EMAIL="${{ secrets.DEV_ADMIN_EMAIL }}" \
              --env S3_BUCKET_NAME="${{ secrets.DEV_S3_BUCKET_NAME }}" \
              --env SENTRY_AUTH_TOKEN="${{ secrets.SENTRY_AUTH_TOKEN }}" \
              --env CORS_ENABLED_ORIGINS="${{ secrets.CORS_ENABLED_ORIGINS }}" \
              --env STORAGE_CDN_URL="${{ secrets.DEV_STORAGE_CDN_URL }}" \
              --env CONTRACT_QUEUE="${{ secrets.CONTRACT_QUEUE_DEV }}" \
              --env EXTRACTION_QUEUE="${{ secrets.EXTRACTION_QUEUE_DEV }}" \
              --env SCOPE_OF_WORK_QUEUE="${{ secrets.SCOPE_OF_WORK_QUEUE_DEV }}" \
              --env ONLYOFFICE_JWT_SECRET="${{ secrets.ONLYOFFICE_JWT_SECRET_DEV }}" \
              --env ONLYOFFICE_CALLBACK_URL="${{ secrets.ONLYOFFICE_CALLBACK_URL_DEV }}" \
              --env TEMPLATE_GENERATION_QUEUE="${{ secrets.TEMPLATE_GENERATION_QUEUE_DEV }}" \
              --env EXPORT_QUEUE_URL="${{ vars.EXPORT_QUEUE_URL_DEV }}" \
              $REPO_URI:\$IMAGE_TAG
          EOF
          rm private_key.pem
  deploy-sowrfq:
    if: github.ref == 'refs/heads/dev'
    needs: deploy-connexus
    runs-on: blacksmith
    env:
      AWS_REGION: us-east-1
      REPO_URI: >-
        ${{ secrets.AWS_ACCOUNT_ID
        }}.dkr.ecr.us-east-1.amazonaws.com/connexus-api
      NODE_ENV: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Notify Google Chat - Starting Dev Deployment
        env:
          WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
                  "text": "üöÄ Starting deployment of SOW-RFQ API to Dev.\n\n Commit: ${{ github.event.head_commit.message }}"
                }' $WEBHOOK_URL
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: '${{ secrets.AWS_ACCESS_KEY_ID }}'
          aws-secret-access-key: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          aws-region: '${{ env.AWS_REGION }}'
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1
      - name: Build & Push SOW-RFQ API
        run: |
          IMAGE_TAG=sowrfqdev-${{ github.sha }}
          docker build --build-arg NODE_ENV=$NODE_ENV \
          -f apps/sow-rfq/Dockerfile \
          -t $REPO_URI:$IMAGE_TAG .
          docker push $REPO_URI:$IMAGE_TAG
      - name: Install SSH Client
        run: sudo apt-get install -y sshpass
      - name: Deploy SOW-RFQ API on EC2
        run: |
          cat <<EOF > private_key.pem
          ${{ secrets.EC2_SSH_KEY_NON_PROD }}
          EOF
          chmod 600 private_key.pem
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{
          secrets.EC2_USER_NON_PROD }}@${{ secrets.EC2_HOST_NON_PROD }} << EOF
            IMAGE_TAG=sowrfqdev-${{ github.sha }}
            CONTAINER_NAME=sow-rfq-app-dev
            PORT=4001
            docker stop \$CONTAINER_NAME || true
            docker rm \$CONTAINER_NAME || true
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REPO_URI
            docker pull $REPO_URI:\$IMAGE_TAG
            docker run -d --name \$CONTAINER_NAME -p \$PORT:3001 \
              --env NODE_ENV=development \
              --env DATABASE_URL="${{ secrets.AWS_LOCAL_DEV_DB_SECRET }}" \
              --env SHADOW_DATABASE_URL="${{ secrets.AWS_LOCAL_DEV_SHADOW_DB_SECRET }}" \
              --env COGNITO_USER_POOL_ID="${{ secrets.DEV_COGNITO_USER_POOL_ID }}" \
              --env COGNITO_CLIENT_ID="${{ vars.DEV_COGNITO_CLIENT_ID }}" \
              --env COGNITO_CLIENT_SECRET="${{ vars.DEV_COGNITO_CLIENT_SECRET }}" \
              --env AWS_REGION="${{ secrets.DEV_COGNITO_REGION }}" \
              --env AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              --env AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              --env AUTH_JWT_SECRET="${{ secrets.DEV_AUTH_JWT_SECRET }}" \
              --env FRONTEND_URL="${{ secrets.DEV_FRONTEND_URL }}" \
              --env EMAIL_ASSET_URL="${{ vars.DEV_EMAIL_ASSET_URL }}" \
              --env ADMIN_EMAIL="${{ secrets.DEV_ADMIN_EMAIL }}" \
              --env S3_BUCKET_NAME="${{ secrets.DEV_S3_BUCKET_NAME }}" \
              --env SENTRY_AUTH_TOKEN="${{ secrets.SENTRY_AUTH_TOKEN }}" \
              --env CORS_ENABLED_ORIGINS="${{ secrets.CORS_ENABLED_ORIGINS }}" \
              --env STORAGE_CDN_URL="${{ secrets.DEV_STORAGE_CDN_URL }}" \
              --env CONTRACT_QUEUE="${{ secrets.CONTRACT_QUEUE_DEV }}" \
              --env EXTRACTION_QUEUE="${{ secrets.EXTRACTION_QUEUE_DEV }}" \
              --env SCOPE_OF_WORK_QUEUE="${{ secrets.SCOPE_OF_WORK_QUEUE_DEV }}" \
              --env ONLYOFFICE_JWT_SECRET="${{ secrets.ONLYOFFICE_JWT_SECRET_DEV }}" \
              --env ONLYOFFICE_CALLBACK_URL="${{ secrets.ONLYOFFICE_CALLBACK_URL_DEV }}" \
              --env OPENAI_ENDPOINT="${{ secrets.OPENAI_ENDPOINT }}" \
              --env OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              --env OPENAI_DEPLOYMENT_VERSION="${{ secrets.OPENAI_DEPLOYMENT_VERSION }}" \
              --env TEMPLATE_GENERATION_QUEUE="${{ secrets.TEMPLATE_GENERATION_QUEUE_DEV }}" \
              --env EXPORT_QUEUE_URL="${{ vars.EXPORT_QUEUE_URL_DEV }}" \
              $REPO_URI:\$IMAGE_TAG
            sudo docker image prune -f
            sudo docker system prune --all --volumes --force
          EOF
          rm private_key.pem
      - name: Notify Google Chat - Dev
        env:
          WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
                  "text": "‚úÖ Connexus & SOW-RFQ deployed to Dev.\n\n Commit: ${{ github.event.head_commit.message }}"
                }' $WEBHOOK_URL
      - name: Notify Google Chat on failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
                  "text": "‚ùó Deployment failed for job: ${{ github.job }}.\n\nSee logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }'
  deploy-connexus-test:
    if: github.ref == 'refs/heads/test'
    runs-on: blacksmith
    env:
      AWS_REGION: us-east-1
      REPO_URI: >-
        ${{ secrets.AWS_ACCOUNT_ID
        }}.dkr.ecr.us-east-1.amazonaws.com/connexus-api
      NODE_ENV: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Notify Google Chat - Starting Test Deployment
        env:
          WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
                  "text": "üöÄ Starting deployment of Connexus API to Test.\n\n Commit: ${{ github.event.head_commit.message }}"
                }' $WEBHOOK_URL
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: '${{ secrets.AWS_ACCESS_KEY_ID }}'
          aws-secret-access-key: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          aws-region: '${{ env.AWS_REGION }}'
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1
      - name: Build & Push Connexus API
        run: |
          IMAGE_TAG=connexustest-${{ github.sha }}
          docker build \
          --build-arg NODE_ENV=$NODE_ENV \
          -f apps/connexus-be/Dockerfile \
          -t $REPO_URI:$IMAGE_TAG .
          
          docker push $REPO_URI:$IMAGE_TAG
      - name: Install SSH Client
        run: sudo apt-get install -y sshpass
      - name: Deploy Connexus API on EC2
        run: |
          cat <<EOF > private_key.pem
          ${{ secrets.EC2_SSH_KEY_NON_PROD }}
          EOF
          chmod 600 private_key.pem
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{
          secrets.EC2_USER_NON_PROD }}@${{ secrets.EC2_HOST_NON_PROD }} << EOF
            IMAGE_TAG=connexustest-${{ github.sha }}
            CONTAINER_NAME=connexus-api-test
            PORT=3001
            docker stop \$CONTAINER_NAME || true
            docker rm \$CONTAINER_NAME || true
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REPO_URI
            docker pull $REPO_URI:\$IMAGE_TAG
            docker run -d --name \$CONTAINER_NAME -p \$PORT:3000 \
              --env NODE_ENV=test \
              --env DATABASE_URL="${{ secrets.AWS_LOCAL_TEST_DB_SECRET }}" \
              --env SHADOW_DATABASE_URL="${{ secrets.AWS_LOCAL_TEST_SHADOW_DB_SECRET }}" \
              --env COGNITO_USER_POOL_ID="${{ secrets.TEST_COGNITO_USER_POOL_ID }}" \
              --env COGNITO_CLIENT_ID="${{ secrets.TEST_COGNITO_CLIENT_ID }}" \
              --env COGNITO_CLIENT_SECRET="${{ secrets.TEST_COGNITO_CLIENT_SECRET }}" \
              --env AWS_REGION="${{ secrets.TEST_COGNITO_REGION }}" \
              --env AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              --env AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              --env AUTH_JWT_SECRET="${{ secrets.TEST_AUTH_JWT_SECRET }}" \
              --env FRONTEND_URL="${{ secrets.TEST_FRONTEND_URL }}" \
              --env EMAIL_ASSET_URL="${{ secrets.TEST_EMAIL_ASSET_URL }}" \
              --env ADMIN_EMAIL="${{ secrets.TEST_ADMIN_EMAIL }}" \
              --env S3_BUCKET_NAME="${{ secrets.TEST_S3_BUCKET_NAME }}" \
              --env SENTRY_AUTH_TOKEN="${{ secrets.SENTRY_AUTH_TOKEN }}" \
              --env CORS_ENABLED_ORIGINS="${{ secrets.CORS_ENABLED_ORIGINS }}" \
              --env STORAGE_CDN_URL="${{ secrets.TEST_STORAGE_CDN_URL }}" \
              --env CONTRACT_QUEUE="${{ secrets.CONTRACT_QUEUE_TEST }}" \
              --env EXTRACTION_QUEUE="${{ secrets.EXTRACTION_QUEUE_TEST }}" \
              --env SCOPE_OF_WORK_QUEUE="${{ secrets.SCOPE_OF_WORK_QUEUE_TEST }}" \
              --env TEMPLATE_GENERATION_QUEUE="${{ secrets.TEMPLATE_GENERATION_QUEUE_TEST }}" \
              --env EXPORT_QUEUE_URL="${{ vars.EXPORT_QUEUE_URL_TEST }}" \
              $REPO_URI:\$IMAGE_TAG
          EOF
          rm private_key.pem
  deploy-sowrfq-test:
    if: github.ref == 'refs/heads/test'
    needs: deploy-connexus-test
    runs-on: blacksmith
    env:
      AWS_REGION: us-east-1
      REPO_URI: >-
        ${{ secrets.AWS_ACCOUNT_ID
        }}.dkr.ecr.us-east-1.amazonaws.com/connexus-api
      NODE_ENV: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Notify Google Chat - Starting Test Deployment
        env:
          WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
                  "text": "üöÄ Starting deployment of SOW-RFQ API to Test.\n\n Commit: ${{ github.event.head_commit.message }}"
                }' $WEBHOOK_URL
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: '${{ secrets.AWS_ACCESS_KEY_ID }}'
          aws-secret-access-key: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          aws-region: '${{ env.AWS_REGION }}'
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1
      - name: Build & Push SOW-RFQ API
        run: |
          IMAGE_TAG=sowrfqtest-${{ github.sha }}
          docker build \
          --build-arg NODE_ENV=$NODE_ENV \
          -f apps/sow-rfq/Dockerfile \
          -t $REPO_URI:$IMAGE_TAG .
          
          docker push $REPO_URI:$IMAGE_TAG
      - name: Install SSH Client
        run: sudo apt-get install -y sshpass
      - name: Deploy SOW-RFQ API on EC2
        run: |
          cat <<EOF > private_key.pem
          ${{ secrets.EC2_SSH_KEY_NON_PROD }}
          EOF
          chmod 600 private_key.pem
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{
          secrets.EC2_USER_NON_PROD }}@${{ secrets.EC2_HOST_NON_PROD }} << EOF
            IMAGE_TAG=sowrfqtest-${{ github.sha }}
            CONTAINER_NAME=sow-rfq-app-test
            PORT=4002
            docker stop \$CONTAINER_NAME || true
            docker rm \$CONTAINER_NAME || true
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REPO_URI
            docker pull $REPO_URI:\$IMAGE_TAG
            docker run -d --name \$CONTAINER_NAME -p \$PORT:3001 \
              --env NODE_ENV=test \
              --env DATABASE_URL="${{ secrets.AWS_LOCAL_TEST_DB_SECRET }}" \
              --env SHADOW_DATABASE_URL="${{ secrets.AWS_LOCAL_TEST_SHADOW_DB_SECRET }}" \
              --env COGNITO_USER_POOL_ID="${{ secrets.TEST_COGNITO_USER_POOL_ID }}" \
              --env COGNITO_CLIENT_ID="${{ secrets.TEST_COGNITO_CLIENT_ID }}" \
              --env COGNITO_CLIENT_SECRET="${{ secrets.TEST_COGNITO_CLIENT_SECRET }}" \
              --env AWS_REGION="${{ secrets.TEST_COGNITO_REGION }}" \
              --env AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              --env AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              --env AUTH_JWT_SECRET="${{ secrets.TEST_AUTH_JWT_SECRET }}" \
              --env FRONTEND_URL="${{ secrets.TEST_FRONTEND_URL }}" \
              --env EMAIL_ASSET_URL="${{ secrets.TEST_EMAIL_ASSET_URL }}" \
              --env ADMIN_EMAIL="${{ secrets.TEST_ADMIN_EMAIL }}" \
              --env S3_BUCKET_NAME="${{ secrets.TEST_S3_BUCKET_NAME }}" \
              --env SENTRY_AUTH_TOKEN="${{ secrets.SENTRY_AUTH_TOKEN }}" \
              --env CORS_ENABLED_ORIGINS="${{ secrets.CORS_ENABLED_ORIGINS }}" \
              --env STORAGE_CDN_URL="${{ secrets.TEST_STORAGE_CDN_URL }}" \
              --env CONTRACT_QUEUE="${{ secrets.CONTRACT_QUEUE_TEST }}" \
              --env EXTRACTION_QUEUE="${{ secrets.EXTRACTION_QUEUE_TEST }}" \
              --env SCOPE_OF_WORK_QUEUE="${{ secrets.SCOPE_OF_WORK_QUEUE_TEST }}" \
              --env ONLYOFFICE_JWT_SECRET="${{ secrets.ONLYOFFICE_JWT_SECRET_TEST }}" \
              --env ONLYOFFICE_CALLBACK_URL="${{ secrets.ONLYOFFICE_CALLBACK_URL_TEST }}" \
              --env OPENAI_ENDPOINT="${{ secrets.OPENAI_ENDPOINT }}" \
              --env OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              --env OPENAI_DEPLOYMENT_VERSION="${{ secrets.OPENAI_DEPLOYMENT_VERSION }}" \
              --env TEMPLATE_GENERATION_QUEUE="${{ secrets.TEMPLATE_GENERATION_QUEUE_TEST }}" \
              --env EXPORT_QUEUE_URL="${{ vars.EXPORT_QUEUE_URL_TEST }}" \
              $REPO_URI:\$IMAGE_TAG
            sudo docker image prune -f
            sudo docker system prune --all --volumes --force
          EOF
          rm private_key.pem
      - name: Notify Google Chat - Test
        env:
          WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
                  "text": "‚úÖ Connexus & SOW-RFQ deployed to Test.\n\n Commit: ${{ github.event.head_commit.message }}"
                }' $WEBHOOK_URL
      - name: Notify Google Chat on failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
                  "text": "‚ùó Deployment failed for job: ${{ github.job }}.\n\nSee logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }'
  deploy-connexus-stage:
    if: github.ref == 'refs/heads/stage'
    runs-on: blacksmith
    env:
      AWS_REGION: us-east-1
      REPO_URI: >-
        ${{ secrets.AWS_ACCOUNT_ID
        }}.dkr.ecr.us-east-1.amazonaws.com/connexus-api
      NODE_ENV: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Notify Google Chat - Starting Stage Deployment
        env:
          WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
                  "text": "üöÄ Starting deployment of Connexus API to Stage.\n\n Commit: ${{ github.event.head_commit.message }}"
                }' $WEBHOOK_URL
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: '${{ secrets.AWS_ACCESS_KEY_ID }}'
          aws-secret-access-key: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          aws-region: '${{ env.AWS_REGION }}'
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1
      - name: Build & Push Connexus API
        run: |
          IMAGE_TAG=connexusstage-${{ github.sha }}
          docker build --build-arg NODE_ENV=$NODE_ENV -f apps/connexus-be/Dockerfile -t $REPO_URI:$IMAGE_TAG .
          docker push $REPO_URI:$IMAGE_TAG
      - name: Install SSH Client
        run: sudo apt-get install -y sshpass
      - name: Deploy Connexus API on EC2
        run: |
          cat <<EOF > private_key.pem
          ${{ secrets.EC2_SSH_KEY_NON_PROD }}
          EOF
          chmod 600 private_key.pem
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{
          secrets.EC2_USER_NON_PROD }}@${{ secrets.EC2_HOST_NON_PROD }} << EOF
            IMAGE_TAG=connexusstage-${{ github.sha }}
            CONTAINER_NAME=connexus-api-stage
            PORT=3002
            docker stop \$CONTAINER_NAME || true
            docker rm \$CONTAINER_NAME || true
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REPO_URI
            docker pull $REPO_URI:\$IMAGE_TAG
            docker run -d --name \$CONTAINER_NAME -p \$PORT:3000 \
              --env NODE_ENV=development \
              --env DATABASE_URL="${{ secrets.AWS_LOCAL_STAGE_DB_SECRET }}" \
              --env SHADOW_DATABASE_URL="${{ secrets.AWS_LOCAL_STAGE_SHADOW_DB_SECRET }}" \
              --env COGNITO_USER_POOL_ID="${{ secrets.STAGE_COGNITO_USER_POOL_ID }}" \
              --env COGNITO_CLIENT_ID="${{ secrets.STAGE_COGNITO_CLIENT_ID }}" \
              --env COGNITO_CLIENT_SECRET="${{ secrets.STAGE_COGNITO_CLIENT_SECRET }}" \
              --env AWS_REGION="${{ secrets.STAGE_COGNITO_REGION }}" \
              --env AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              --env AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              --env AUTH_JWT_SECRET="${{ secrets.STAGE_AUTH_JWT_SECRET }}" \
              --env FRONTEND_URL="${{ secrets.STAGE_FRONTEND_URL }}" \
              --env EMAIL_ASSET_URL="${{ secrets.STAGE_EMAIL_ASSET_URL }}" \
              --env ADMIN_EMAIL="${{ secrets.STAGE_ADMIN_EMAIL }}" \
              --env S3_BUCKET_NAME="${{ secrets.STAGE_S3_BUCKET_NAME }}" \
              --env SENTRY_AUTH_TOKEN="${{ secrets.SENTRY_AUTH_TOKEN }}" \
              --env CORS_ENABLED_ORIGINS="${{ secrets.CORS_ENABLED_ORIGINS }}" \
              --env STORAGE_CDN_URL="${{ secrets.STAGE_STORAGE_CDN_URL }}" \
              --env CONTRACT_QUEUE="${{ secrets.CONTRACT_QUEUE_STAGE }}" \
              --env EXTRACTION_QUEUE="${{ secrets.EXTRACTION_QUEUE_STAGE }}" \
              --env SCOPE_OF_WORK_QUEUE="${{ secrets.SCOPE_OF_WORK_QUEUE_STAGE }}" \
              --env ONLYOFFICE_JWT_SECRET="${{ secrets.ONLYOFFICE_JWT_SECRET_STAGE }}" \
              --env ONLYOFFICE_CALLBACK_URL="${{ vars.ONLYOFFICE_CALLBACK_URL_STAGE }}" \
              --env OPENAI_ENDPOINT="${{ secrets.OPENAI_ENDPOINT }}" \
              --env OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              --env OPENAI_DEPLOYMENT_VERSION="${{ secrets.OPENAI_DEPLOYMENT_VERSION }}" \
              --env TEMPLATE_GENERATION_QUEUE="${{ secrets.TEMPLATE_GENERATION_QUEUE_STAGE }}" \
              --env EXPORT_QUEUE_URL="${{ vars.EXPORT_QUEUE_URL_STAGE }}" \
              $REPO_URI:\$IMAGE_TAG
          EOF
          rm private_key.pem
  deploy-sowrfq-stage:
    if: github.ref == 'refs/heads/stage'
    needs: deploy-connexus-stage
    runs-on: blacksmith
    env:
      AWS_REGION: us-east-1
      REPO_URI: >-
        ${{ secrets.AWS_ACCOUNT_ID
        }}.dkr.ecr.us-east-1.amazonaws.com/connexus-api
      NODE_ENV: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Notify Google Chat - Starting Stage Deployment
        env:
          WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
                  "text": "üöÄ Starting deployment of SOW-RFQ API to Stage.\n\n Commit: ${{ github.event.head_commit.message }}"
                }' $WEBHOOK_URL
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: '${{ secrets.AWS_ACCESS_KEY_ID }}'
          aws-secret-access-key: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          aws-region: '${{ env.AWS_REGION }}'
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1
      - name: Build & Push SOW-RFQ API
        run: |
          IMAGE_TAG=sowrfqstage-${{ github.sha }}
          docker build --build-arg NODE_ENV=$NODE_ENV -f apps/sow-rfq/Dockerfile -t $REPO_URI:$IMAGE_TAG .
          docker push $REPO_URI:$IMAGE_TAG
      - name: Install SSH Client
        run: sudo apt-get install -y sshpass
      - name: Deploy SOW-RFQ API on EC2
        run: |
          cat <<EOF > private_key.pem
          ${{ secrets.EC2_SSH_KEY_NON_PROD }}
          EOF
          chmod 600 private_key.pem
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{
          secrets.EC2_USER_NON_PROD }}@${{ secrets.EC2_HOST_NON_PROD }} << EOF
            IMAGE_TAG=sowrfqstage-${{ github.sha }}
            CONTAINER_NAME=sow-rfq-app-stage
            PORT=4003
            docker stop \$CONTAINER_NAME || true
            docker rm \$CONTAINER_NAME || true
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REPO_URI
            docker pull $REPO_URI:\$IMAGE_TAG
            docker run -d --name \$CONTAINER_NAME -p \$PORT:3001 \
              --env NODE_ENV=development \
              --env DATABASE_URL="${{ secrets.AWS_LOCAL_STAGE_DB_SECRET }}" \
              --env SHADOW_DATABASE_URL="${{ secrets.AWS_LOCAL_STAGE_SHADOW_DB_SECRET }}" \
              --env COGNITO_USER_POOL_ID="${{ secrets.STAGE_COGNITO_USER_POOL_ID }}" \
              --env COGNITO_CLIENT_ID="${{ secrets.STAGE_COGNITO_CLIENT_ID }}" \
              --env COGNITO_CLIENT_SECRET="${{ secrets.STAGE_COGNITO_CLIENT_SECRET }}" \
              --env AWS_REGION="${{ secrets.STAGE_COGNITO_REGION }}" \
              --env AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              --env AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              --env AUTH_JWT_SECRET="${{ secrets.STAGE_AUTH_JWT_SECRET }}" \
              --env FRONTEND_URL="${{ secrets.STAGE_FRONTEND_URL }}" \
              --env EMAIL_ASSET_URL="${{ secrets.STAGE_EMAIL_ASSET_URL }}" \
              --env ADMIN_EMAIL="${{ secrets.STAGE_ADMIN_EMAIL }}" \
              --env S3_BUCKET_NAME="${{ secrets.STAGE_S3_BUCKET_NAME }}" \
              --env SENTRY_AUTH_TOKEN="${{ secrets.SENTRY_AUTH_TOKEN }}" \
              --env CORS_ENABLED_ORIGINS="${{ secrets.CORS_ENABLED_ORIGINS }}" \
              --env STORAGE_CDN_URL="${{ secrets.STAGE_STORAGE_CDN_URL }}" \
              --env CONTRACT_QUEUE="${{ secrets.CONTRACT_QUEUE_STAGE }}" \
              --env EXTRACTION_QUEUE="${{ secrets.EXTRACTION_QUEUE_STAGE }}" \
              --env SCOPE_OF_WORK_QUEUE="${{ secrets.SCOPE_OF_WORK_QUEUE_STAGE }}" \
              --env OPENAI_ENDPOINT="${{ secrets.OPENAI_ENDPOINT }}" \
              --env OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              --env ONLYOFFICE_JWT_SECRET="${{ secrets.ONLYOFFICE_JWT_SECRET_STAGE }}" \
              --env ONLYOFFICE_CALLBACK_URL="${{ vars.ONLYOFFICE_CALLBACK_URL_STAGE }}" \
              --env OPENAI_DEPLOYMENT_VERSION="${{ secrets.OPENAI_DEPLOYMENT_VERSION }}" \
              --env TEMPLATE_GENERATION_QUEUE="${{ secrets.TEMPLATE_GENERATION_QUEUE_STAGE }}" \
              --env EXPORT_QUEUE_URL="${{ vars.EXPORT_QUEUE_URL_STAGE }}" \
              $REPO_URI:\$IMAGE_TAG
            sudo docker image prune -f
            sudo docker system prune --all --volumes --force
          EOF
          rm private_key.pem
      - name: Notify Google Chat - Stage
        env:
          WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
                  "text": "‚úÖ Connexus & SOW-RFQ deployed to Stage.\n\n Commit: ${{ github.event.head_commit.message }}"
                }' $WEBHOOK_URL
      - name: Notify Google Chat on failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
                  "text": "‚ùó Deployment failed for job: ${{ github.job }}.\n\nSee logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }'

  deploy-prod:
    if: github.ref == 'refs/heads/prod'
    runs-on: blacksmith-arm
    timeout-minutes: 25
    env:
      IMAGE_NAME: connexus-prod-api
      AWS_REGION: us-east-1
      ENVIRONMENT: prod
      CONTAINER_NAME: connexus-api-prod

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Notify Google Chat - Starting Prod Deployment
      env:
        WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
      run: |
        curl -X POST -H 'Content-Type: application/json' \
        -d '{"text": "üöÄ Starting deployment of connexus-api to Prod."}' $WEBHOOK_URL

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: '${{ secrets.AWS_ACCESS_KEY_ID }}'
        aws-secret-access-key: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
        aws-region: '${{ env.AWS_REGION }}'

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v1

    - name: Set environment variables
      run: echo "REPOSITORY_URI=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.IMAGE_NAME }}" >> $GITHUB_ENV

    - name: Build and push Docker image for connexus-api
      uses: docker/build-push-action@v6
      with:
        context: .
        file: apps/connexus-be/Dockerfile
        platforms: linux/arm64
        push: true
        tags: '${{ env.REPOSITORY_URI }}:connexus-api-${{ github.sha }}'
        cache-from: type=registry,ref=${{ env.REPOSITORY_URI }}:buildcache
        cache-to: type=inline
        build-args: |
          NODE_ENV=prod

    - name: Deploy connexus-api container using SSM
      run: |
        aws ssm send-command \
          --region ${{ env.AWS_REGION }} \
          --document-name "AWS-RunShellScript" \
          --targets "Key=instanceIds,Values=${{ secrets.EC2_INSTANCE_ID_PROD }}" \
          --parameters 'commands=[
            "sudo usermod -aG docker $(whoami)",
            "sudo aws ecr get-login-password --region ${{ env.AWS_REGION }} | sudo docker login --username AWS --password-stdin ${{ env.REPOSITORY_URI }}",
            "sudo docker system prune -a -f",
            "sudo docker pull ${{ env.REPOSITORY_URI }}:connexus-api-${{ github.sha }}",
            "CONTAINER_ID=$(sudo docker ps -aq -f name=${{ env.CONTAINER_NAME }}); if [ ! -z \"$CONTAINER_ID\" ]; then sudo docker stop $CONTAINER_ID || true; sudo docker rm $CONTAINER_ID || true; fi",
            "sudo docker run -d --restart unless-stopped -p 3003:3000 --name ${{ env.CONTAINER_NAME }} \
              --env NODE_ENV=prod \
              --env DATABASE_URL=\"${{ secrets.AWS_LOCAL_PROD_DB_SECRET }}\" \
              --env SHADOW_DATABASE_URL=\"${{ secrets.AWS_LOCAL_PROD_SHADOW_DB_SECRET }}\" \
              --env COGNITO_USER_POOL_ID=\"${{ secrets.PROD_COGNITO_USER_POOL_ID }}\" \
              --env COGNITO_CLIENT_ID=\"${{ secrets.PROD_COGNITO_CLIENT_ID }}\" \
              --env COGNITO_CLIENT_SECRET=\"${{ secrets.PROD_COGNITO_CLIENT_SECRET }}\" \
              --env AWS_REGION=\"${{ secrets.PROD_COGNITO_REGION }}\" \
              --env AWS_ACCESS_KEY_ID=\"${{ secrets.AWS_ACCESS_KEY_ID }}\" \
              --env AWS_SECRET_ACCESS_KEY=\"${{ secrets.AWS_SECRET_ACCESS_KEY }}\" \
              --env AUTH_JWT_SECRET=\"${{ secrets.PROD_AUTH_JWT_SECRET }}\" \
              --env EXPORT_QUEUE_URL=\"${{ vars.EXPORT_QUEUE_URL_PROD }}\" \
              --env FRONTEND_URL=\"${{ secrets.PROD_FRONTEND_URL }}\" \
              --env EMAIL_ASSET_URL=\"${{ secrets.PROD_EMAIL_ASSET_URL }}\" \
              --env ADMIN_EMAIL=\"${{ secrets.PROD_ADMIN_EMAIL }}\" \
              --env S3_BUCKET_NAME=\"${{ secrets.PROD_S3_BUCKET_NAME }}\" \
              --env SENTRY_AUTH_TOKEN=\"${{ secrets.SENTRY_AUTH_TOKEN }}\" \
              --env CORS_ENABLED_ORIGINS=\"${{ secrets.PROD_CORS_ENABLED_ORIGINS }}\" \
              --env STORAGE_CDN_URL=\"${{ secrets.PROD_STORAGE_CDN_URL }}\" \
              --env CONTRACT_QUEUE=\"${{ secrets.CONTRACT_QUEUE_PROD }}\" \
              --env EXTRACTION_QUEUE=\"${{ secrets.EXTRACTION_QUEUE_PROD }}\" \
              --env SCOPE_OF_WORK_QUEUE=\"${{ secrets.SCOPE_OF_WORK_QUEUE_PROD }}\" \
              ${{ env.REPOSITORY_URI }}:connexus-api-${{ github.sha }}",
            "echo Checking container status...",
            "sudo docker ps -a -f name=${{ env.CONTAINER_NAME }} || true",
            "echo Checking app health endpoint...",
            "curl -f http://localhost:3000/health || echo Health check failed || true"
          ]' \
          --comment "Deploying connexus-api container to prod"

    - name: Notify Google Chat - Prod Success
      env:
        WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
      run: |
        curl -X POST -H 'Content-Type: application/json' \
        -d '{"text": "‚úÖ connexus-api has been deployed to the prod environment."}' $WEBHOOK_URL

    - name: Notify Google Chat on failure
      if: failure()
      run: |
        curl -X POST "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{"text": "‚ùó CI/CD Pipeline failed for job: ${{ github.job }}.\n\nLogs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'

  deploy-sow-prod:
    if: github.ref == 'refs/heads/prod'
    needs: deploy-prod
    runs-on: blacksmith-arm
    timeout-minutes: 25
    env:
      IMAGE_NAME: connexus-prod-api
      AWS_REGION: us-east-1
      ENVIRONMENT: prod
      CONTAINER_NAME: sow-app-prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Notify Google Chat - Starting Prod Deployment
        env:
          WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
        run: |
          curl -X POST -H 'Content-Type: application/json' \
          -d '{"text": "üöÄ Starting deployment of sow-app to Prod."}' $WEBHOOK_URL
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: '${{ secrets.AWS_ACCESS_KEY_ID }}'
          aws-secret-access-key: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          aws-region: '${{ env.AWS_REGION }}'

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Set environment variables
        run: echo "REPOSITORY_URI=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.IMAGE_NAME }}" >> $GITHUB_ENV

      - name: Build and push Docker image for sow-app
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/sow-rfq/Dockerfile
          platforms: linux/arm64
          push: true
          tags: '${{ env.REPOSITORY_URI }}:sow-app-${{ github.sha }}'
          cache-from: type=registry,ref=${{ env.REPOSITORY_URI }}:buildcache
          cache-to: type=inline
          build-args: |
            NODE_ENV=prod
      - name: Deploy sow-app container using SSM
        run: |
          aws ssm send-command \
            --region ${{ env.AWS_REGION }} \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceIds,Values=${{ secrets.EC2_INSTANCE_ID_PROD }}" \
            --parameters 'commands=[
              "sudo usermod -aG docker $(whoami)",
              "sudo aws ecr get-login-password --region ${{ env.AWS_REGION }} | sudo docker login --username AWS --password-stdin ${{ env.REPOSITORY_URI }}",
              "sudo docker system prune -a -f",
              "sudo docker pull ${{ env.REPOSITORY_URI }}:sow-app-${{ github.sha }}",
              "CONTAINER_ID=$(sudo docker ps -aq -f name=${{ env.CONTAINER_NAME }}); if [ ! -z \"$CONTAINER_ID\" ]; then sudo docker stop $CONTAINER_ID || true; sudo docker rm $CONTAINER_ID || true; fi",
              "sudo docker run -d --restart unless-stopped -p 4004:3001 --name ${{ env.CONTAINER_NAME }} \
                --env NODE_ENV=prod \
                --env DATABASE_URL=\"${{ secrets.AWS_LOCAL_PROD_DB_SECRET }}\" \
                --env SHADOW_DATABASE_URL=\"${{ secrets.AWS_LOCAL_PROD_SHADOW_DB_SECRET }}\" \
                --env COGNITO_USER_POOL_ID=\"${{ secrets.PROD_COGNITO_USER_POOL_ID }}\" \
                --env COGNITO_CLIENT_ID=\"${{ secrets.PROD_COGNITO_CLIENT_ID }}\" \
                --env COGNITO_CLIENT_SECRET=\"${{ secrets.PROD_COGNITO_CLIENT_SECRET }}\" \
                --env AWS_REGION=\"${{ secrets.PROD_COGNITO_REGION }}\" \
                --env AWS_ACCESS_KEY_ID=\"${{ secrets.AWS_ACCESS_KEY_ID }}\" \
                --env AWS_SECRET_ACCESS_KEY=\"${{ secrets.AWS_SECRET_ACCESS_KEY }}\" \
                --env AUTH_JWT_SECRET=\"${{ secrets.PROD_AUTH_JWT_SECRET }}\" \
                --env FRONTEND_URL=\"${{ secrets.PROD_FRONTEND_URL }}\" \
                --env EXPORT_QUEUE_URL=\"${{ vars.EXPORT_QUEUE_URL_PROD }}\" \
                --env EMAIL_ASSET_URL=\"${{ secrets.PROD_EMAIL_ASSET_URL }}\" \
                --env ADMIN_EMAIL=\"${{ secrets.PROD_ADMIN_EMAIL }}\" \
                --env S3_BUCKET_NAME=\"${{ secrets.PROD_S3_BUCKET_NAME }}\" \
                --env SENTRY_AUTH_TOKEN=\"${{ secrets.SENTRY_AUTH_TOKEN }}\" \
                --env CORS_ENABLED_ORIGINS=\"${{ secrets.PROD_CORS_ENABLED_ORIGINS }}\" \
                --env STORAGE_CDN_URL=\"${{ secrets.PROD_STORAGE_CDN_URL }}\" \
                --env CONTRACT_QUEUE=\"${{ secrets.CONTRACT_QUEUE_PROD }}\" \
                --env EXTRACTION_QUEUE=\"${{ secrets.EXTRACTION_QUEUE_PROD }}\" \
                --env SCOPE_OF_WORK_QUEUE=\"${{ secrets.SCOPE_OF_WORK_QUEUE_PROD }}\" \
                --env ONLYOFFICE_JWT_SECRET=\"${{ secrets.ONLYOFFICE_JWT_SECRET_PROD }}\" \
                --env ONLYOFFICE_CALLBACK_URL=\"${{ vars.ONLYOFFICE_CALLBACK_URL_PROD }}\" \
                --env TEMPLATE_GENERATION_QUEUE=\"${{ vars.TEMPLATE_GENERATION_QUEUE_PROD }}\" \
                --env OPENAI_API_KEY=\"${{ secrets.OPENAI_API_KEY }}\" \
                ${{ env.REPOSITORY_URI }}:sow-app-${{ github.sha }}",
              "echo \"Checking if the container is running...\"",
              "sudo docker ps -a -f name=${{ env.CONTAINER_NAME }} || true"
            ]' \
            --comment "Deploying sow-app container to prod"
      - name: Notify Google Chat - Prod
        env:
          WEBHOOK_URL: '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}'
        run: |
          curl -X POST -H 'Content-Type: application/json' \
          -d '{"text": "‚úÖ sow-app has been deployed to the prod environment."}' $WEBHOOK_URL
      - name: Notify Google Chat on failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               -d '{
                     "text": "‚ùó CI/CD Pipeline failed for job: ${{ github.job }} in workflow: ${{ github.workflow }}.\n\nCheck the logs here: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                   }'

            
  
